import{deepmerge as t}from"https://esm.sh/deepmerge-ts@5.1.0";import e from"https://esm.sh/exceljs@4.4.0";function r(t){return"number"==typeof t?function(t){if(t<1||!Number.isInteger(t))throw new RangeError("Column index must be a positive integer");let e="";for(;t>0;){const r=(t-1)%26;e=String.fromCharCode(65+r)+e,t=Math.floor((t-r)/26)}return e}(t):function(t){if(!t.match(/^[A-Z]+$/))throw new RangeError("Invalid column name");let e=0;for(const r of t)e=26*e+r.charCodeAt(0)-64;return e}(t)}function o(t,e,r=1){if(0===r)throw new Error("Step cannot be zero.");let o=r;return t>e&&r>0&&(o=-r),{*[Symbol.iterator](){for(let r=t;o>=0?r<=e:r>=e;r+=o)yield r}}}const n=[["row",/^[1-9][0-9]*$/],["col",/^[A-Z]+$/],["cell",/^[A-Z]+[1-9][0-9]*$/]];function i(t){if(t.includes(":")){const[e,r,...o]=t.split(":");if(o.length)throw new Error(`Invalid range "${t}": too many parts`);const n=i(e),s=i(r);if(n.type===s.type)return{...s,isRange:!0};throw new Error(`Invalid range "${t}": different types`)}let e;for(const[r,o]of n)t.match(o)&&(e=r);if(e)return{type:e,isRange:!1};throw new Error(`Invalid addr "${t}": unknown type`)}function s(t){if(t.includes(","))return t.split(",").map(s).flat();const{type:e,isRange:n}=i(t);if(!n)return[t];const[l,h]=t.split(":");if("cell"===e)return a(t).flat();const c=[];if("row"===e)for(const t of o(+l,+h))c.push(String(t));else if("col"===e)for(const t of o(r(l),r(h)))c.push(r(t));return c}function a(t){const e=s(t.replace(/\d/g,""));return s(t.replace(/[A-Z]/g,"")).map((t=>e.map((e=>e+t))))}function l(t="A1",{rows:e=1,cols:o=1}){const[n,i]=t.match(/[A-Z]+|[0-9]+/g);return`${t}:${r(r(n)+o-1)}${+i+e-1}`}function h(t){const[e,o]=t.match(/[A-Z]+|[0-9]+/g);return[r(e),+o]}function c(t,e){return r(t)+e}function u(t){const e=new Set;return t.forEach((t=>Object.keys(t).forEach((t=>e.add(t))))),[...e]}function f(t){return null==t}function d(t,e){return function(t,{defaultValue:e}={}){const r=Math.max(...t.map((t=>t.length)));return Array(r).fill(0).map(((r,o)=>t.map((t=>o in t?t[o]:e))))}([t=[t].flat(),e=(e=[e].flat().slice(0,t.length)).concat(Array(t.length-e.length).fill(e.at(-1)))])}function m(t,e=!1){const r=Array.isArray(t)?t:[t];return e||"string"!=typeof r[0]?r:r.join(",").split(",")}function p(t,e=/\s+/){return String(t).trim().split(e).map((t=>t.trim()))}const g=864e5;function w(t){return"number"==typeof t?function(t){if("number"!=typeof t||t>=60&&t<61)return new Date(NaN);const e=t>60?25569:25568;return new Date((Math.trunc(t)-e+t%1)*g)}(t):function(t){if(Number.isNaN(+t))return NaN;const e=t.getTime()>=-22038912e5?25569:25568;return t.getTime()/g+e}(t)}function y(t,e){const[r,o]=h(e).map((t=>t-1));if(r<0||r>=t.columnCount||o<0||o>=t.rowCount)throw new Error(`(${e}) is out of range`);if(f(t.data(e)[0][0]))throw new Error(`(${e}) is empty`);const n=[],i=[],s=[[r,o]];for(;s.length;){const[e,r]=s.shift();i[e]?.[r]||(i[e]??=[],i[e][r]=!0,n.push([e,r]),e&&!f(t.data(c(e,r+1))[0][0])&&s.push([e-1,r]),f(t.data(c(e+2,r+1))[0][0])||s.push([e+1,r]),r&&!f(t.data(c(e+1,r))[0][0])&&s.push([e,r-1]),f(t.data(c(e+1,r+2))[0][0])||s.push([e,r+1]))}const[a,l,u,d]=n.reduce((([t,e,r,o],[n,i])=>[Math.min(t,n),Math.max(e,n),Math.min(r,i),Math.max(o,i)]),[1/0,-1/0,1/0,-1/0]);return c(a+1,u+1)+":"+c(l+1,d+1)}function b(t,{header:e,hTrans:r=(t=>t)}={}){const o=e||u(t).map((t=>({name:r(t)})));return[o.map((t=>r(t.rename||t.name))),...t.map((t=>o.map((({name:e,trans:r})=>r?.(t[e])??t[e]))))]}function v(t,{header:e,hTrans:r=(t=>t)}={}){const o=e||t[0].map((t=>({name:r(t)}))),n=t[0].map(r);return t.slice(1).map((t=>Object.fromEntries(o.map((e=>{const r=n.indexOf(e.name);return[e.rename||e.name,e?.trans?.(t[r])??t[r]]})))))}function k(t,e=(()=>{})){for(const[r,o]of t.entries())for(const[t,n]of o.entries())e(n,r,t)}function C(t,e=(()=>{})){const o=s(t.replace(/\d/g,"")),n=s(t.replace(/[A-Z]/g,""));for(const t of n)for(const n of o)e(n+t,+t-1,r(n)-1)}function x(t){if(null==t||"number"==typeof t||"string"==typeof t||"boolean"==typeof t)return t;if("object"!=typeof t)throw new Error(`Unexpected value type: ${typeof t}`);return"error"in t?t.error:"text"in t?t.text:"richText"in t?t.richText.map((t=>t.text)).join(""):t instanceof Date?w(t):"formula"in t||"sharedFormula"in t?x(t.result):void 0}const S={serif:1,"sans-serif":2,monospace:3};function $(t,e,r,o){if(e<r||e>o||!Number.isInteger(e))throw new Error(`${t} must be an integer between ${r} and ${o}`)}function E({numFmt:t,font:e,size:r,color:o,bold:n,italic:i,underline:s,vertAlign:a,strike:l,horizontal:h,vertical:c,wrapText:u,shrinkToFit:f,indent:d,readingOrder:m,textRotation:g,borderStyle:w,borderColor:y,diagBorderType:b,diagBorderStyle:v,diagBorderColor:k,fill:C,locked:x,hidden:E}={}){const A={},z={},F=T({borderStyle:w,borderColor:y,diagBorderType:b,diagBorderStyle:v,diagBorderColor:k}),N=function(t="none"){const[e,r,o]=t.trim().split(/\s+/);if("angle"===e||"path"===e)return function(t){const[e,r,...o]=p(t);if("angle"!==e&&"path"!==e)throw new Error("gradient type must be angle or path");const n={type:"gradient",gradient:e,stops:o.map((t=>{const[e,r]=t.split(",");return{position:+e,color:R(r)}}))};if("angle"===e)return{...n,degree:+r};{const[t,e]=r.split(",");return{...n,center:{left:+t,top:+e}}}}(t);const n={type:"pattern",pattern:e};r&&(n.fgColor=R(r));o&&(n.bgColor=R(o));return n}(C),B={};if(e){const[t,r]=p(e,",");r?(A.name=t,A.family=S[r]||4):t in S?A.family=S[t]:A.name=t}return void 0!==r&&($("fontSize",r,1,409),A.size=r),void 0!==o&&(A.color=R(o)),void 0!==n&&(A.bold=n),void 0!==i&&(A.italic=i),void 0!==s&&(A.underline=s),void 0!==a&&(A.vertAlign=a),void 0!==l&&(A.strike=l),void 0!==h&&(z.horizontal=h),void 0!==c&&(z.vertical=c),void 0!==u&&(z.wrapText=u),void 0!==f&&(z.shrinkToFit=f),void 0!==d&&(z.indent=d),void 0!==m&&(z.readingOrder=m),void 0!==g&&(z.textRotation=g),void 0!==x&&(B.locked=x),void 0!==E&&(B.hidden=E),{numFmt:t,font:A,alignment:z,border:F,fill:N,protection:B}}function A(t,e=t,r=t,o=e){return[t,e,r,o]}function T({borderStyle:t="",borderColor:e="#000000",diagBorderType:r="",diagBorderStyle:o="",diagBorderColor:n="#000000"}={}){const[i,s,a,l]=A(...p(t)),[h,c,u,f]=A(...p(e)).map(R),d=p(r),m={top:{style:i,color:h},right:{style:s,color:c},bottom:{style:a,color:u},left:{style:l,color:f},didiagonal:{up:d.includes("up"),down:d.includes("down"),style:o,color:R(n)}};for(const[t,e]of Object.entries(m))e.style||delete m[t];return m}function R(t){if("string"==typeof t){if(t.match(/^\d+$/))return R(+t);if(!/^#[0-9a-fA-F]{6}$/.test(t))throw new Error("color must be a hex string");return{argb:"FF"+t.slice(1)}}return $("color",t,0,11),{theme:t}}class z{#t;#e;constructor(t,e){this.#e=t,this.#t=e}get sheet(){return this.#e}get book(){return this.#t}get rowCount(){return this.#e.rowCount}get columnCount(){return this.#e.columnCount}get actualRowCount(){return this.#e.actualRowCount}get actualColumnCount(){return this.#e.actualColumnCount}get lastRow(){return this.#e.lastRow}get lastColumn(){return this.#e.lastColumn}col(t){return this.#e.getColumn(t)}row(t){return this.#e.getRow(Number(t))}cell(t){return this.#e.getCell(t)}name(t){return void 0===t?this.#e.model.name:(this.#e.name=t,this)}state(t){return void 0===t?this.#e.state:(this.#e.state=t,this)}data(t="A1",{data:e,extend:r,value:o,header:n,json:i,hTrans:s}={}){if(void 0===e){if(r){if(t.includes(":"))throw new Error("Cannot extend range");return this.data(y(this,t),{value:o,header:n,json:i,hTrans:s})}const e=a(t).map((t=>t.map((t=>{const e=this.cell(t).value;return o?x(e):e}))));return i?v(e,{header:n,hTrans:s}):e}if(!e.length)return this;const h=i?b(e,{header:n,hTrans:s}):e;if(r){if(t.includes(":"))throw new Error("Cannot extend range");const e=l(t,{rows:h.length,cols:h.reduce(((t,e)=>Math.max(t,e.length)),0)});return this.data(e,{data:h,value:o})}const c=a(t);return k(h,((t,e,r)=>{void 0!==t&&(this.cell(c[e][r]).value=o?x(t):t)})),this}style(e,r){const o=E(r);for(const r of m(e))for(const e of s(r)){const r=this.cell(e);r.style=t(r.style,o)}return this}validate(t,e){for(const r of m(t))for(const t of s(r)){this.cell(t).dataValidation=e}return this}comment(t,e){for(const r of m(t))for(const t of s(r)){const r=this.cell(t);if(void 0===e){const{comment:t,...e}=r.model;r.model=e}else r.note=e}return this}border(e,r="none"){const[o,n]=p(r),{top:i,right:a,bottom:l,left:u}=T({borderStyle:o,borderColor:n});for(const r of m(e)){if(!r.includes(":"))throw new Error(r+" is not a range");const[e,o]=r.split(":"),[n,f]=h(e),[d,m]=h(o),p=c(n,m),g=c(d,f),w=(e,r,o)=>{for(const n of s(`${e}:${r}`)){const e=this.cell(n);e.border=t(e.border,o)}};w(e,g,{top:i}),w(g,o,{right:a}),w(o,p,{bottom:l}),w(p,e,{left:u})}return this}merge(t){for(const e of m(t))this.#e.mergeCells(e);return this}#r(t,e){for(const r of m(t))for(const t of s(r))t.match(/^[A-Z]+$/)?e(this.col(t)):e(this.row(t));return this}hide(t){return this.#r(t,(t=>{t.hidden=!0}))}show(t){return this.#r(t,(t=>{t.hidden=!1}))}view(e=0,r){return void 0===r?this.#e.views[e]:(this.#e.views[e]=t(this.#e.views[e],r),this)}freeze(t,e,o=0){const n={state:"frozen"};if(e&&(n.topLeftCell=e),"number"==typeof t||t.match(/^[0-9]+$/))n.xSplit=0,n.ySplit=Number(t);else if(t.match(/^[A-Z]+$/))n.xSplit=r(t),n.ySplit=0;else{const[e,r]=h(t);n.xSplit=e,n.ySplit=r}return this.view(o,n),this}defreeze(t=0){return this.view(t,{state:"normal"}),this}size(t,e){const r=m(t);if(void 0===e){const t=[];for(const e of r.map(String))e.includes(":")?t.push(s(e).map((t=>this.size(t)[0]))):e.match(/^[A-Z]+$/)?t.push(this.col(e).width||0):t.push(this.row(e).height||0);return t}const o=[e].flat();return r.forEach(((t,e)=>{const r=o[e]??o.at(-1);for(const e of s(String(t)))e.match(/^[A-Z]+$/)?this.col(e).width=r:this.row(e).height=r})),this}formula(t,e,r){const o=m(t),n=m(e,!0),i=m(r,!0);return o.forEach(((t,e)=>this.data(t,{data:[[{formula:n[e],result:i[e]}]]}))),this}fillFormula(t,e,r){return this.#e.fillFormula(t,e,r),this}filter(t){return this.#e.autoFilter=t,this}protect(t,e={}){return void 0===t?this.#e.unprotect():this.#e.protect(t,e),this}}class F{#t;#o;constructor(t,r){this.#t=new e.Workbook,this.#o=this.load(t,r)}get ready(){return this.#o}get book(){return this.#t}async load(t,e){return"string"==typeof t?await this.#t.xlsx.readFile(t,e):t&&await this.#t.xlsx.load(t,e),this}toBuffer(){return this.#t.xlsx.writeBuffer()}sheet(t){const e=this.#t.getWorksheet(t);if(e)return new z(e,this);throw new Error(`Sheet ${t} not found`)}addSheet(t,e){try{const r=this.#t.addWorksheet(t);return e&&(r.model={...e.sheet.model,id:r.model.id,name:t}),new z(r,this)}catch{throw new Error(`Sheet ${t} already exists`)}}removeSheet(t){const e=this.#t.getWorksheet(t);e&&this.#t.removeWorksheet(e.id)}sheets(){return this.#t.worksheets.map((t=>new z(t,this)))}*sheetsIterator(){for(const t of this.#t.worksheets)yield new z(t,this)}getSheetNames(){return this.#t.worksheets.map((t=>t.name))}}export{F as KBook,h as addr2xy,w as convertDate,m as deMulti,r as ecn,a as expandCellRange,l as extendAddr,i as getAddrType,u as getAllKeys,x as getCellPrimitiveValue,E as getStyle,y as getXRange,f as isNullish,b as jsonToTable,T as makeBorders,d as pair,s as parseAddr,o as range,p as split,v as tableToJson,k as traverse,C as traverseCells,c as xy2addr};
